<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Camera Object Detection System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4CAF50;
        }
        
        .status-bar {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
        }
        
        .status-indicator.connected {
            background: #4CAF50;
        }
        
        .controls {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .camera-card {
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .camera-header {
            padding: 15px;
            background: #3a3a3a;
            border-bottom: 2px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .camera-feed {
            position: relative;
            width: 100%;
            min-height: 360px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-feed img {
            width: 100%;
            height: auto;
        }
        
        .no-feed {
            color: #888;
            font-size: 16px;
        }
        
        .detection-info {
            padding: 15px;
        }
        
        .detection-count {
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .detection-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .detection-list li {
            padding: 8px;
            margin-bottom: 5px;
            background: #3a3a3a;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .stats {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            background: #3a3a3a;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .cameras-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ Multi-Camera Object Detection System</h1>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="backend-status"></div>
                <span>Backend</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="vllm-status"></div>
                <span>VLLM AI</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="detection-status"></div>
                <span>Detection Service</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="camera1-status"></div>
                <span>Camera 1</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="camera2-status"></div>
                <span>Camera 2</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn-primary" onclick="initializeCameras()">Initialize Cameras</button>
            <button class="btn-secondary" onclick="refreshFrames()">Refresh Now</button>
            <button class="btn-secondary" onclick="analyzeAllCameras()" style="background:#FF9800">ðŸ¤– Analyze All with AI</button>
            <label>
                <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
                Auto-refresh
            </label>
            <select id="refreshInterval" onchange="updateRefreshInterval()">
                <option value="500">0.5s</option>
                <option value="1000" selected>1s</option>
                <option value="2000">2s</option>
                <option value="5000">5s</option>
            </select>
        </div>
        
        <div class="cameras-grid">
            <div class="camera-card">
                <div class="camera-header">
                    <h3>Camera 1 (192.168.1.4)</h3>
                    <span class="detection-count" id="cam1-count">0 objects</span>
                </div>
                <div class="camera-feed">
                    <img id="cam1-image" style="display:none" alt="Camera 1">
                    <div class="no-feed" id="cam1-placeholder">No feed available</div>
                </div>
                <div class="detection-info">
                    <strong>Detections:</strong>
                    <ul class="detection-list" id="cam1-detections"></ul>
                    <button class="btn-analyze" onclick="analyzeCamera('cam1')" style="margin-top:10px;width:100%;padding:10px;background:#FF9800;color:white;border:none;border-radius:5px;cursor:pointer;font-weight:600">
                        ðŸ¤– Analyze with AI
                    </button>
                    <div id="cam1-analysis" style="margin-top:10px;padding:10px;background:#3a3a3a;border-radius:5px;display:none">
                        <strong style="color:#FF9800">AI Analysis:</strong>
                        <p id="cam1-analysis-text" style="margin:5px 0;color:#fff"></p>
                    </div>
                </div>
            </div>
            
            <div class="camera-card">
                <div class="camera-header">
                    <h3>Camera 2 (192.168.1.7)</h3>
                    <span class="detection-count" id="cam2-count">0 objects</span>
                </div>
                <div class="camera-feed">
                    <img id="cam2-image" style="display:none" alt="Camera 2">
                    <div class="no-feed" id="cam2-placeholder">No feed available</div>
                </div>
                <div class="detection-info">
                    <strong>Detections:</strong>
                    <ul class="detection-list" id="cam2-detections"></ul>
                    <button class="btn-analyze" onclick="analyzeCamera('cam2')" style="margin-top:10px;width:100%;padding:10px;background:#FF9800;color:white;border:none;border-radius:5px;cursor:pointer;font-weight:600">
                        ðŸ¤– Analyze with AI
                    </button>
                    <div id="cam2-analysis" style="margin-top:10px;padding:10px;background:#3a3a3a;border-radius:5px;display:none">
                        <strong style="color:#FF9800">AI Analysis:</strong>
                        <p id="cam2-analysis-text" style="margin:5px 0;color:#fff"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="frames-count">0</div>
                <div class="stat-label">Frames Processed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-detections">0</div>
                <div class="stat-label">Total Detections</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="last-update">-</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>
    </div>
    
    <script>
        // Use relative URL to work with any host
        const BACKEND_URL = window.location.origin;
        let autoRefreshInterval = null;
        let refreshDelay = 1000;
        let framesProcessed = 0;
        let totalDetections = 0;
        
        // Check backend health
        async function checkHealth() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();
                
                document.getElementById('backend-status').classList.add('connected');
                document.getElementById('vllm-status').classList.toggle('connected', data.vllm_ready);
                document.getElementById('detection-status').classList.toggle('connected', data.detection_service_ready);
                
                // Log VLLM status
                if (data.vllm_ready) {
                    console.log('âœ… VLLM AI is ready:', data.vllm_info);
                } else {
                    console.log('âš ï¸  VLLM AI is not available');
                }
                
                return true;
            } catch (error) {
                console.error('Health check failed:', error);
                document.getElementById('backend-status').classList.remove('connected');
                return false;
            }
        }
        
        // Initialize cameras
        async function initializeCameras() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/cameras/initialize`, {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('Cameras initialized:', data);
                
                setTimeout(refreshFrames, 1000);
            } catch (error) {
                console.error('Failed to initialize cameras:', error);
                alert('Failed to initialize cameras. Check console for details.');
            }
        }
        
        // Refresh camera frames
        async function refreshFrames() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/cameras/all/frames?detect=true`);
                const data = await response.json();
                
                if (data.success && data.cameras) {
                    framesProcessed++;
                    totalDetections = 0;
                    
                    // Update Camera 1
                    if (data.cameras.cam1) {
                        updateCamera('cam1', data.cameras.cam1);
                        totalDetections += (data.cameras.cam1.detections || []).length;
                    }
                    
                    // Update Camera 2
                    if (data.cameras.cam2) {
                        updateCamera('cam2', data.cameras.cam2);
                        totalDetections += (data.cameras.cam2.detections || []).length;
                    }
                    
                    // Update stats
                    document.getElementById('frames-count').textContent = framesProcessed;
                    document.getElementById('total-detections').textContent = totalDetections;
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Failed to refresh frames:', error);
            }
        }
        
        // Update camera display
        function updateCamera(camId, camData) {
            const img = document.getElementById(`${camId}-image`);
            const placeholder = document.getElementById(`${camId}-placeholder`);
            const countElem = document.getElementById(`${camId}-count`);
            const detectionsElem = document.getElementById(`${camId}-detections`);
            const statusElem = document.getElementById(`${camId}-status`);
            
            // Store camera data for analysis
            currentCameraData[camId] = camData;
            
            if (camData.image_base64) {
                img.src = `data:image/jpeg;base64,${camData.image_base64}`;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                statusElem.classList.add('connected');
            } else {
                img.style.display = 'none';
                placeholder.style.display = 'block';
                statusElem.classList.remove('connected');
            }
            
            const detections = camData.detections || [];
            countElem.textContent = `${detections.length} object${detections.length !== 1 ? 's' : ''}`;
            
            detectionsElem.innerHTML = '';
            detections.forEach(det => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${det.label}</span>
                    <span style="color: #4CAF50">${(det.confidence * 100).toFixed(1)}%</span>
                `;
                detectionsElem.appendChild(li);
            });
        }
        
        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const enabled = document.getElementById('autoRefresh').checked;
            
            if (enabled) {
                autoRefreshInterval = setInterval(refreshFrames, refreshDelay);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        // Update refresh interval
        function updateRefreshInterval() {
            refreshDelay = parseInt(document.getElementById('refreshInterval').value);
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = setInterval(refreshFrames, refreshDelay);
            }
        }
        
        // Store current camera data for analysis
        let currentCameraData = {
            cam1: null,
            cam2: null
        };
        
        // Analyze single camera with VLLM
        async function analyzeCamera(camId) {
            const analysisDiv = document.getElementById(`${camId}-analysis`);
            const analysisText = document.getElementById(`${camId}-analysis-text`);
            const btn = event.target;
            
            try {
                // Disable button
                btn.disabled = true;
                btn.textContent = 'ðŸ¤– Analyzing...';
                
                // Show analysis div
                analysisDiv.style.display = 'block';
                analysisText.textContent = 'Äang phÃ¢n tÃ­ch vá»›i VLLM AI...';
                
                const camData = currentCameraData[camId];
                if (!camData || !camData.image_base64) {
                    analysisText.textContent = 'KhÃ´ng cÃ³ áº£nh Ä‘á»ƒ phÃ¢n tÃ­ch. Vui lÃ²ng refresh camera.';
                    btn.disabled = false;
                    btn.textContent = 'ðŸ¤– Analyze with AI';
                    return;
                }
                
                // Call VLLM API
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `HÃ£y mÃ´ táº£ chi tiáº¿t nhá»¯ng gÃ¬ báº¡n tháº¥y trong áº£nh tá»« ${camId === 'cam1' ? 'Camera 1' : 'Camera 2'}. PhÃ¢n tÃ­ch cÃ¡c váº­t thá»ƒ, hoáº¡t Ä‘á»™ng, vÃ  bá»‘i cáº£nh.`,
                        image_data: `data:image/jpeg;base64,${camData.image_base64}`,
                        include_objects: true,
                        confidence_threshold: 0.5
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    analysisText.textContent = data.response || 'KhÃ´ng cÃ³ pháº£n há»“i tá»« AI';
                    console.log('VLLM Analysis:', data);
                } else {
                    const errorText = await response.text();
                    analysisText.textContent = `Lá»—i: ${errorText}`;
                    console.error('VLLM API error:', errorText);
                }
                
            } catch (error) {
                console.error('Failed to analyze camera:', error);
                analysisText.textContent = `Lá»—i káº¿t ná»‘i: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸ¤– Analyze with AI';
            }
        }
        
        // Analyze all cameras
        async function analyzeAllCameras() {
            alert('Äang phÃ¢n tÃ­ch cáº£ 2 camera vá»›i VLLM AI...');
            await Promise.all([
                analyzeCamera('cam1'),
                analyzeCamera('cam2')
            ]);
        }
        
        // Initialize on load
        window.onload = () => {
            checkHealth();
            setInterval(checkHealth, 5000);
            
            // Start auto-refresh
            toggleAutoRefresh();
        };
    </script>
</body>
</html>
